AWSTemplateFormatVersion: '2010-09-09'
Description: ADF CloudFormation Template For CodePipeline - Github Source and CloudFormation Deployment Target
Parameters:
  ProjectName:
    Description: Name of the Project
    Type: String
  Image:
    Description: The Image for CodeBuild to use
    Type: String
    Default: "aws/codebuild/python:3.7.1"
  StackPrefix:
    Description: Prefix to prepend to the stackname when deployed
    Type: String
    Default: adf
  NotificationEndpoint:
    Description: The email address that emails will go to for changes related to this pipeline
    Type: String
  ComputeType:
    Description: The ComputeType for CodeBuild
    Type: String
    Default: "BUILD_GENERAL1_SMALL"
  WebhookSecret:
    Description: Webhook Secret from Github
    Type: AWS::SSM::Parameter::Value<String>
    NoEcho: true
    Default: /tokens/webhook/github
  OAuthToken:
    Description: OAuthToken from Github
    Type: AWS::SSM::Parameter::Value<String>
    NoEcho: true
    Default: /tokens/oauth/github
  Owner:
    Description: The owner of the github Repo
    Type: String
  BranchName:
    Description: Branch to build from
    Type: String
    Default: "master"
  RestartExecutionOnUpdate:
    Description: If the pipeline will automatically trigger based on update
    Type: String
    Default: False
{% for region in regions %}
  S3Bucket{{ region|replace("-", "") }}:
    Description: The S3 Bucket for Cross region deployment for {{ region }}
    Type: AWS::SSM::Parameter::Value<String>
    Default: /cross_region/s3_regional_bucket/{{ region }}
  KMSKey{{ region|replace("-", "") }}:
    Description: The KMSKey Arn for Cross region deployment for {{ region }}
    Type: AWS::SSM::Parameter::Value<String>
    Default: /cross_region/kms_arn/{{ region }}
{% endfor %}
Resources:
  Webhook:
    Type: 'AWS::CodePipeline::Webhook'
    Properties:
      AuthenticationConfiguration:
        SecretToken: !Ref WebhookSecret
      Filters:
      - JsonPath: "$.ref"
        MatchEquals: !Sub "refs/heads/{BranchName}"
      Authentication: GITHUB_HMAC
      TargetPipeline: !Ref Pipeline
      TargetAction: Source
      Name: !Sub "adf-webhook-${ProjectName}"
      TargetPipelineVersion: !GetAtt Pipeline.Version
      RegisterWithThirdParty: 'true'
  BuildProject:
    Type: AWS::CodeBuild::Project
    Properties:
      Name: !Sub "adf-build-${ProjectName}"
      Description: !Sub "CodeBuild Project ${ProjectName} created by ADF"
      EncryptionKey: !ImportValue KMSArn-{{ deployment_account_region }}
      ServiceRole: !ImportValue CodeBuildRoleArn
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        Type: linuxContainer
        ComputeType: !Ref ComputeType
        Image: !Ref Image
        EnvironmentVariables:
          - Name: PROJECT_NAME
            Value: !Ref ProjectName
          - Name: S3_BUCKET_NAME
            Value: !ImportValue S3Bucket-{{ deployment_account_region }}
          - Name: ACCOUNT_ID
            Value: !Ref AWS::AccountId
      Source:
        Type: CODEPIPELINE
      TimeoutInMinutes: 20
      Tags:
        - Key: Name
          Value: !Ref ProjectName
  PipelineSNSTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref NotificationEndpoint
          Protocol: email
  PipelineSNSTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Id: !Sub "${AWS::StackName}"
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Service:
              - events.amazonaws.com
              - codecommit.amazonaws.com
          Action: sns:Publish
          Resource: "*"
      Topics:
      - !Ref PipelineSNSTopic
  Pipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties:
      RoleArn: !ImportValue CodePipelineRoleArn
      Name: !Ref AWS::StackName
      RestartExecutionOnUpdate: !Ref RestartExecutionOnUpdate
      Stages:
        - Name: Source-GitHub
          Actions:
            - Name: Source
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Version: 1
                Provider: GitHub
              Configuration:
                Owner: !Ref Owner
                Repo: !Ref ProjectName
                Branch: !Ref BranchName
                OAuthToken: !Ref OAuthToken
                PollForSourceChanges: false
              OutputArtifacts: 
                - Name: TemplateSource
              RunOrder: 1
        - Name: Build
          ActionTypeId:
            Category: Build
            Owner: AWS
            Version: 1
            Provider: CodeBuild
          Configuration:
            ProjectName: !Sub "adf-build-${ProjectName}"
          RunOrder: 1
          InputArtifacts:
            - Name: TemplateSource
          OutputArtifacts:
            - Name: !Sub "${ProjectName}-build"
{% for target in environments['targets'] %}
{% if target|length > 0 and target[0].get('name') == "approval" %}
        - Name: approval-stage-{{loop.index}}
          Actions:
            - Name: Approve
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Version: 1
                Provider: Manual
              Configuration:
                NotificationArn: !Ref PipelineSNSTopic
                CustomData: "Approve or Reject this deployment"
              RunOrder: 1
{% else %}
        - Name: deployment-stage-{{loop.index}}
          Actions:
{% for stage in target %}
{% if top_level_regions == [] %}
{% for region in stage.regions %}
            - Name: {{ stage.name }}-{{ region }}-replace
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: 1
                Provider: CloudFormation
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                StackName: !Sub "${StackPrefix}-${ProjectName}"
                ChangeSetName: !Sub "${StackPrefix}-${ProjectName}"
                TemplatePath: !Sub "${ProjectName}-Build::template.yml"
                TemplateConfiguration: !Sub "${ProjectName}-Build::params/{{ stage.name }}_{{ region }}.json"
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-deployment-role"
              InputArtifacts:
                - Name: !Sub "${ProjectName}-build"
              RunOrder: 1
              Region: {{ region }}
              RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-role"
            - Name: {{ stage.name }}-{{ region }}-execute
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: 1
                Provider: CloudFormation
              Configuration:
                ChangeSetName: !Sub "${StackPrefix}-${ProjectName}"
                ActionMode: CHANGE_SET_EXECUTE
                StackName: !Sub "${StackPrefix}-${ProjectName}"
                RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-deployment-role" 
              InputArtifacts:
                - Name: !Sub "${ProjectName}-build"
              RunOrder: 2
              Region: {{ region }}
              RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-role"
{% endfor %}
{% else %}
{% for top_level_region in top_level_regions %}
            - Name: {{ stage.name }}-{{ top_level_region }}-replace
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: 1
                Provider: CloudFormation
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                StackName: !Sub "${StackPrefix}-${ProjectName}"
                ChangeSetName: !Sub "${StackPrefix}-${ProjectName}"
                TemplatePath: !Sub "${ProjectName}-Build::template.yml"
                TemplateConfiguration: !Sub "${ProjectName}-Build::params/{{ stage.name }}_{{ top_level_region }}.json"
                Capabilities: CAPABILITY_NAMED_IAM
                RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-deployment-role"
              InputArtifacts:
                - Name: !Sub "${ProjectName}-build"
              RunOrder: 1
              Region: {{ top_level_region }}
              RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-role"
            - Name: {{ stage.name }}-{{ top_level_region }}-execute
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Version: 1
                Provider: CloudFormation
              Configuration:
                ChangeSetName: !Sub "${StackPrefix}-${ProjectName}"
                ActionMode: CHANGE_SET_EXECUTE
                StackName: !Sub "${StackPrefix}-${ProjectName}"
                RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-deployment-role" 
              InputArtifacts:
                - Name: !Sub "${ProjectName}-build"
              RunOrder: 2
              Region: {{ top_level_region }}
              RoleArn: "arn:aws:iam::{{ stage.id }}:role/adf-cloudformation-role"
{% endfor %}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
      ArtifactStores:
{% for region in regions %}
        - Region: {{ region }}
          ArtifactStore:
            EncryptionKey:
              Id: !Ref KMSKey{{ region|replace("-", "") }}
              Type: KMS
            Location: !Ref S3Bucket{{ region|replace("-", "") }}
            Type: S3
{% endfor %}
Outputs:
  PipelineUrl:
    Value: !Sub https://console.aws.amazon.com/codepipeline/home?region=${AWS::Region}#/view/${Pipeline}